FROM debian:stable

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && \
    apt install -y samba samba-vfs-modules && \
    rm -rf /var/lib/apt/lists/*

# Create internal privileged UNIX user
RUN useradd -M -s /usr/sbin/nologin simadmin

# Create Samba user with empty password
RUN (echo ""; echo "") | smbpasswd -a -s simadmin

# Create share directory and give ownership to simadmin
RUN mkdir -p /data/samba && \
    chown -R simadmin:simadmin /data/samba

# Copy configs
COPY smb.conf /etc/samba/smb.conf
COPY username.map /etc/samba/username.map

# Ensure correct permissions
RUN chmod 644 /etc/samba/smb.conf /etc/samba/username.map

EXPOSE 137/udp 138/udp 139/tcp 445/tcp

CMD ["smbd", "-F", "--no-process-group", "--configfile=/etc/samba/smb.conf"]
